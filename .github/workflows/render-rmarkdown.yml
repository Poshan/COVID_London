name: Render and Deploy R Markdown to GitHub Pages

on:
  push:
    branches:
      - master 
  pull_request:
    branches:
      - master
  workflow_dispatch:  # Allows manual triggering from Actions tab

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  render-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.0'
          use-public-rspm: true
      
      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '3.1.1'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            libgdal-dev \
            libgeos-dev \
            libproj-dev \
            libudunits2-dev
      
      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ hashFiles('**/model_run.Rmd') }}
          restore-keys: |
            ${{ runner.os }}-r-
      
      - name: Install INLA
        run: |
          install.packages("INLA", repos=c(getOption("repos"), INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
        shell: Rscript {0}
      
      - name: Install R dependencies
        run: |
          install.packages(c(
            "rmarkdown",
            "knitr",
            "Metrics",
            "ggplot2",
            "lubridate",
            "arrow",
            "dplyr",
            "tidyr",
            "sf",
            "gridExtra",
            "grid",
            "classInt",
            "viridis"
          ), dependencies = TRUE)
        shell: Rscript {0}
      
      - name: Verify file structure
        run: |
          echo "Current directory:"
          pwd
          echo "Directory contents:"
          ls -R
          echo "Checking for model_run.Rmd:"
          ls -lh model_run.Rmd || echo "model_run.Rmd not found!"
          echo "Checking for required directories:"
          ls -lh 02_Modelling/ || echo "02_Modelling/ not found!"
          ls -lh data/processed_data/lagged/ || echo "data/processed_data/lagged/ not found!"
      
      - name: Render R Markdown
        run: |
          rmarkdown::render(
            input = "model_run.Rmd",
            output_format = "html_document",
            output_file = "model_run.html"
          )
        shell: Rscript {0}
      
      - name: Create docs directory
        run: |
          mkdir -p docs
          cp model_run.html docs/index.html
          # Copy any additional files if needed (e.g., figures, plots)
          if [ -d "plots" ]; then
            cp -r plots docs/
          fi
          if [ -d "figures" ]; then
            cp -r figures docs/
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Optional: Create a summary job that reports the URL
  summary:
    needs: render-and-deploy
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Output Pages URL
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸ“„ Your rendered document is available at:"
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/model_run.html"
